<div class="AppComponentContainer">
    <div class="AppComponentMain">
        <div class="DiagramContainer">
            <CascadingValue Value="diagram">
                <DiagramCanvas></DiagramCanvas>
            </CascadingValue>
        </div>
    </div>
    <aside class="AsideOverview">
        <div class="ScenarioSection">
            <h3>Select a scenario to simulate:</h3>
            @foreach(var scenario in scenarios)
            {
                if(selectedScenario?.Id == scenario.Id)
                {
                    <div itemref="@scenario.Id" class="ScenarioContainer active" @onclick="() => SelectScenario(scenario)">
                        <h4>@scenario.Name</h4>
                        <h6>@scenario.ShortDescription</h6>
                    </div>
                }
                else
                {
                    <div itemref="@scenario.Id" class="ScenarioContainer" @onclick="() => SelectScenario(scenario)">
                        <h4>@scenario.Name</h4>
                        <h6>@scenario.ShortDescription</h6>
                    </div>
                }      
            }
        </div>
        <div class="LearningBadges">
            <h3>Learning badges:</h3>
            @foreach(var learningBage in learningBadges)
            {
                <div class="LearningBadgeContainer">
                    <img src="@($"/LearningBadges/{learningBage.IconUri}")"/>
                    <h6>@learningBage.Description</h6>
                </div>
            }
        </div>
    </aside>
</div>

@code{
    private ScenarioDTO selectedScenario;
    public ScenarioDTO SelectedScenario
    {
        get
        {
            return selectedScenario;
        }
        set
        {
            selectedScenario = value;
            if (selectedScenario.ScenarioType == ScenarioTypeDTO.Bullying)
            {
                var v = diagram.Nodes.AsEnumerable().ToList();
                diagram.Nodes.Remove(v);
                Point one = new Point((diagram.Container.Width / 2) - 160, (diagram.Container.Height / 2) - 160);
                Point two = new Point((diagram.Container.Width / 2) - 160, (diagram.Container.Height / 2) - 160);
                diagram.Nodes.Add(new ScenarioMemberNode(ScenarioRoleDTO.Bystander, one));
                diagram.Nodes.Add(new ScenarioMemberNode(ScenarioRoleDTO.Bystander, two));
                diagram.Nodes.Add(new UserNode(new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
            }
            if (selectedScenario.ScenarioType == ScenarioTypeDTO.Sexism)
            {
                var v = diagram.Nodes.AsEnumerable().ToList();
                diagram.Nodes.Remove(v);
                diagram.Nodes.Add(new ScenarioMemberNode(ScenarioRoleDTO.Bystander, new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
                diagram.Nodes.Add(new UserNode(new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
            }
            if (selectedScenario.ScenarioType == ScenarioTypeDTO.SubtleSexism)
            {
                var v = diagram.Nodes.AsEnumerable().ToList();
                diagram.Nodes.Remove(v);
                diagram.Nodes.Add(new ScenarioMemberNode(ScenarioRoleDTO.Bystander, new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
                diagram.Nodes.Add(new ScenarioMemberNode(ScenarioRoleDTO.Bystander, new Point((diagram.Container.Width / 2), (diagram.Container.Height / 2))));
                diagram.Nodes.Add(new UserNode(new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
            }
            StateHasChanged();
        }
    }
    private Diagram diagram;
    List<LearningBadgeDTO> learningBadges = new List<LearningBadgeDTO>();
    List<ScenarioDTO> scenarios = new List<ScenarioDTO>();
    protected override async Task OnInitializedAsync()
    {
        var options = new DiagramOptions
        {
            DeleteKey = "Delete",
            DefaultNodeComponent = null,
            AllowMultiSelection = true,
            AllowPanning = false,
            Zoom = new DiagramZoomOptions
            {
                Enabled = false
            },
            Links = new DiagramLinkOptions
            {
                DefaultColor = "black"
            }
        };

        diagram = new Diagram(options);
        await Task.Delay(200);
        StateHasChanged();

        learningBadges = await HttpClientService.GetFromAPIAsync<List<LearningBadgeDTO>>("/learningbadges");
        scenarios = await HttpClientService.GetFromAPIAsync<List<ScenarioDTO>>("/scenarios");

        diagram.RegisterModelComponent<InformationNode, InformationNodeComponent>();
        diagram.RegisterModelComponent<UserNode, UserComponent>();
        diagram.RegisterModelComponent<ScenarioMemberNode, ScenarioMemberComponent>();

        if(SelectedScenario == null)
        {
            diagram.Nodes.Add(new InformationNode(new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
        }
        else
        {
            diagram.Nodes.Add(new UserNode(new Point((diagram.Container.Width / 2) - 60, (diagram.Container.Height / 2) - 40)));
        }
        StateHasChanged();
    }
    public async Task SelectScenario(ScenarioDTO scenario)
    {
        var parameters = new ModalParameters();
        parameters.Add("Scenario", scenario);
        Action<ScenarioDTO> scenarioCallback = (s) => { SelectedScenario = s; StateHasChanged(); };
        parameters.Add("Scenario", scenario);
        parameters.Add("ScenarioSelectedCallback", scenarioCallback);
        Modal.Show<SelectScenarioModal>(string.Empty, parameters);
    }
    private async Task RedrawDiagram()
    {
        var options = new DiagramOptions
        {
            DeleteKey = "Delete",
            DefaultNodeComponent = null,
            AllowMultiSelection = true,
            AllowPanning = false,
            Zoom = new DiagramZoomOptions
            {
                Enabled = false
            },
            Links = new DiagramLinkOptions
            {
                DefaultColor = "black"
            }
        };

        diagram = new Diagram(options);
        await Task.Delay(200);
        StateHasChanged();
    }
}